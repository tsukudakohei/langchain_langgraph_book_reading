# ch04–ch05 輪読会 進行台本（デモ込み）

想定：60〜90分。参加者のレベルは「LangChain初学〜少し触った」。

## ゴール（最初に宣言）

1. ch04: RAGの構成要素（Indexing / Retrieval / Generation）が“手で説明できる”
2. ch04: LangChain v1流のRAG（LCELチェーン or tool+agent）で「最小に動く」体験をする
3. ch05: Runnable = “入出力を持つ処理単位の標準I/F” を理解して、LCELの読み書きができる
4. 追加: Tavily と OpenAI web search の使い分け観点を持ち帰る

## 事前準備チェック（開始5分前）

- `pip install -r requirements.txt` 済み
- `.env` を用意（任意）
  - OPENAI_API_KEY（あるとデモが滑らか）
  - TAVILY_API_KEY（比較デモをやるなら）
  - LANGSMITH_*（今日は“任意”。余裕があれば最後に触れる）
- `.chroma/` はローカル永続。必要なら `.gitignore` に追加する（当日口頭で注意）

---

## タイムテーブル（90分版）

### 0:00–0:05 オープニング

- 今日のゴールを宣言（上記）
- “古いLangChainコードがなぜ辛いか”：importパスの分割、legacy chains の扱い、Runnable中心設計

### 0:05–0:25 ch04（概念パート）

扱う論点：
- Indexing: loader → splitter → embeddings → vector store
- Retrieval: retriever が “質問→関連チャンク” を返す
- Generation: prompt に context を注入して LLM へ
- どこが「差別化ポイント」か（chunk設計/検索k/フィルタ/プロンプト/評価）

質問投げ（短く）：
- 「RAGは何を“固定化”し、何を“動的”にする仕組み？」
- 「embeddings と LLM は同じモデルである必要ある？」
- 「k を上げると何が起きる？（精度/コスト/幻覚/ノイズ）」

### 0:25–0:40 デモ1：ch04 RAGチェーン（LCEL）

1) smoke:
  - `python docker-check/ch04/00_smoke.py`

2) DB作成（API無しでも可）:
  - `DRY_RUN=1 python docker-check/ch04/01_build_vectorstore.py`

3) RAG実行（LCEL）:
  - `DRY_RUN=1 python docker-check/ch04/02_rag_chain_lcel.py --query "RAGとは？" --show-docs`

ポイント解説：
- RunnableParallel で docs と question を束ねる
- assign で context を生成
- prompt | llm | parser で最終回答へ
- DRY_RUNでも “パイプが通る” のが大事（LLMは差し替え可能）

### 0:40–0:55 ch05（Runnableの概念パート）

扱う論点：
- Runnable = すべてを “invoke/batch/stream” で呼べる単位
- Prompt / Model / Parser / Retriever / Tool が Runnable を実装している（≒差し替え容易）
- `|` は RunnableSequence（直列合成）
- RunnableParallel / assign / passthrough の役割

質問投げ：
- 「chainの構成要素ひとつひとつ＝Runnable？」→ “基本YES、ただし streaming など能力差はある”
- 「dictを流すのは何のため？」→ “状態（キー）を増やしながら組み立てる”

### 0:55–1:10 デモ2：Runnable基礎〜RAG形

1) Runnable基礎:
  - `python docker-check/ch05/00_runnable_basics.py`

2) RunnableParallelで“RAGっぽい形”:
  - `DRY_RUN=1 python docker-check/ch05/01_runnable_parallel_rag.py --query "Runnableとは？"`

### 1:10–1:20 デモ3（任意）：RAG agent（tool + create_agent）

- `python docker-check/ch04/03_rag_agent_create_agent.py --query "章4の要点を3つで"`
- APIキーが無い場合は tool 単体で表示される（それでも“retrieval tool”の形は掴める）

問い：
- 「chain方式（常に検索）と agent方式（必要なら検索）のトレードオフは？」

### 1:20–1:30 Tavily vs OpenAI web search（ディスカッション）

デモ（任意）:
- `python docker-check/ch05/02_web_search_compare.py --query "LangChain v1 Runnableとは？"`

問い：
- 「検索を “モデル内蔵ツール” に任せたい？ “外部ツールとして制御したい？”」
- 「ドメイン制限・再現性・キャッシュ・評価をどうしたい？」

---

## 60分版（圧縮）

- ch04概念 12分
- デモ1（LCEL RAG） 10分
- ch05概念 12分
- デモ2（Runnable） 10分
- デモ3（agent） 8分
- Q&A 8分

---

## その場で詰まりやすい点（司会者メモ）

- 依存が入ってない：requirements を案内
- .chroma が空：ch04/02 は bootstrap するので “とりあえず動く”
- APIキー無し：DRY_RUN=1 を促す（デモは成立する）
- “embedding方式の不整合”：登録と検索で embeddings を揃える必要がある（重要ポイントとして言語化）
